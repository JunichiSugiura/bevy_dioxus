<!DOCTYPE html>
<html lang="en">
    {% include "head.html" %}

    <body class="bg-background text-text">
        <div>
            {% include "header/index.html" %}
            {% include "header/menu.html" %}

            {% block breadcrumb %}
            {% endblock breadcrumb %}

            {% block content %}
                <ul class="flex justify-center">
                    <a href="{{ get_url(path = "@/docs/_index.md") }}" alt="Docs Page" class="underline text-accent">
                        <li>Docs</li>
                    </a>
                    <p class="px-4">/</p>
                    <a href="{{ get_url(path = "@/todo.md") }}" alt="Todo Page" class="underline text-accent">
                        <li>Todo</li>
                    </a>
                    <p class="px-4">/</p>
                    <a href="{{ get_url(path = "@/debug/_index.md") }}" alt="Debug Page (dev only)" class="underline text-accent">
                        <li>Debug</li>
                    </a>
                </li>
            {% endblock content %}
        </div>

        <script>
            const themes = ["light", "dark", "system"];

            applyTheme();

            // handlers
            function openMenu() {
                document.getElementById("menu").classList.replace("hidden", "flex");
            }

            function closeMenu() {
                document.getElementById("menu").classList.replace("flex", "hidden");
                closeThemeSelector();
            }

            function openThemeSelector() {
                openDesktopThemeSelector();
                openMobileThemeSelector();
            }

            function openMobileThemeSelector() {
                const $el = document.getElementById("theme-options");
                const ul = document.createElement("ul");
                ul.id = "theme-options";
                ul.className = "absolute w-40 border border-neutral-600 rounded flex flex-col top-4 right-0 bg-background";

                ul.innerHTML = `
                    <li>
                        <button id="theme-options-light" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('light')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/sun.html" %}
                            </div>
                            <div class="text-neutral-300">Light</div>
                        </button>
                    </li>
                    <li>
                        <button id="theme-options-dark" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('dark')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/moon.html" %}
                            </div>
                            <div class="text-neutral-300">Dark</div>
                        </button>
                    </li>
                    <li>
                        <button id="theme-options-system" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('system')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/desktop-computer.html" %}
                            </div>
                            <div class="text-neutral-300">System</div>
                        </button>
                    </li>
                `;

                $el.replaceWith(ul);

                updateThemeOptions();
            }

            function openDesktopThemeSelector() {
                const $el = document.getElementById("md:theme-options");
                const ul = document.createElement("ul");
                ul.id = "md:theme-options";
                ul.className = "absolute w-40 border border-neutral-600 rounded flex flex-col top-16 right-12 bg-background";

                ul.innerHTML = `
                    <li>
                        <button id="theme-options-light" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('light')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/sun.html" %}
                            </div>
                            <div class="text-neutral-300">Light</div>
                        </button>
                    </li>

                    <li>
                        <button id="theme-options-dark" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('dark')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/moon.html" %}
                            </div>
                            <div class="text-neutral-300">Dark</div>
                        </button>
                    </li>

                    <li>
                        <button id="theme-options-system" class="w-full flex items-center p-4 cursor-pointer hover:bg-neutral-900" onclick="onSelectTheme('system')">
                            <div class="mr-4 text-neutral-600">
                                {% include "icons/desktop-computer.html" %}
                            </div>
                            <div class="text-neutral-300">System</div>
                        </button>
                    </li>
                `;

                $el.replaceWith(ul);

                /* updateThemeOptions(); */
            }

            function closeThemeSelector() {
                hideThemeOptions("theme-options");
                hideThemeOptions("md:theme-options");
            }

            function hideThemeOptions(id) {
                const $el = document.getElementById(id);
                $el.classList.remove("flex");
                $el.classList.add("hidden");
            }

            function onSelectTheme(theme) {
                setTheme(theme);
                applyTheme();
                closeThemeSelector();
            }

            // utils
            function applyTheme() {
                updateThemeClass();
                updateSelectedTheme();
            }

            function setTheme(theme) {
                switch (theme) {
                    case "light":
                    case "dark":
                        localStorage.setItem("theme", theme);
                        break;
                    case "system":
                        localStorage.removeItem("theme");
                        break;
                }
            }

            function updateThemeClass() {
                if (
                    localStorage.theme === "dark" || (
                        !("theme" in localStorage) &&
                        window.matchMedia("(prefers-color-scheme: dark)").matches)
                ) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            }

            function updateSelectedTheme() {
                updateDesktopSelectedTheme();
                updateMobileSelectedTheme();
            }

            function updateMobileSelectedTheme() {
                const $el = document.getElementById("theme-selected");
                const theme = getTheme(false);
                const div = document.createElement("div");
                div.id = "theme-selected";
                div.className = "flex items-center justify-between w-full";

                switch (theme) {
                    case "light":
                        div.innerHTML = `
                            <div class="flex items-center">
                                <div class="mr-4 text-neutral-600">
                                    {% include "icons/sun.html" %}
                                </div>
                                <div>Light</div>
                            </div>
                            <div class="text-neutral-600">{% include "icons/chevron-down.html" %}</div>
                        `;
                        break;
                    case "dark":
                        div.innerHTML = `
                            <div class="flex items-center">
                                <div class="mr-4 text-neutral-600">
                                    {% include "icons/moon.html" %}
                                </div>
                                <div>Dark</div>
                            </div>
                            <div class="text-neutral-600">{% include "icons/chevron-down.html" %}</div>
                        `;
                        break;
                    case "system":
                        div.innerHTML = `
                            <div class="flex items-center">
                                <div class="mr-4 text-neutral-600">
                                    {% include "icons/desktop-computer.html" %}
                                </div>
                                <div>System</div>
                            </div>
                            <div class="text-neutral-600">{% include "icons/chevron-down.html" %}</div>
                        `;
                        break;
                }
                $el.replaceWith(div);
            }

            function updateDesktopSelectedTheme() {
                const $el = document.getElementById("md:theme-selected");
                const theme = getTheme();
                const div = document.createElement("div");
                div.id = "md:theme-selected";

                switch (theme) {
                    case "light":
                        div.innerHTML = `
                            <button
                                class="w-10 h-10 flex justify-center items-center mx-2 text-accent"
                                onclick="openThemeSelector()"
                            >
                                {% include "icons/sun.html" %}
                            </button>
                        `;
                        break;
                    case "dark":
                        div.innerHTML = `
                            <button
                                class="w-10 h-10 flex justify-center items-center mx-2 text-accent"
                                onclick="openThemeSelector()"
                            >
                                {% include "icons/moon.html" %}
                            </button>
                        `;
                        break;
                    case "system-light":
                        div.innerHTML = `
                            <button
                                class="w-10 h-10 flex justify-center items-center mx-2"
                                onclick="openThemeSelector()"
                            >
                                {% include "icons/sun.html" %}
                            </button>
                        `;
                        break;
                    case "system-dark":
                        const theme = "bg-neutral-50"
                        div.innerHTML = `
                            <button
                                class="w-10 h-10 flex justify-center items-center mx-2"
                                onclick="openThemeSelector()"
                            >
                                {% include "icons/moon.html" %}
                            </button>
                        `;
                        break;
                }
                $el.replaceWith(div);
            }

            function updateThemeOptions() {
                removeAccents();
                addAccent();
            }

            function addAccent() {
                const [$icon, $text] = document.getElementById(`theme-options-${getTheme(false)}`).getElementsByTagName("div");
                $icon.classList.replace("text-neutral-600", "text-accent");
                $text.classList.replace("text-neutral-300", "text-accent");
            }

            function removeAccents() {
                themes
                    .filter(t => t !== getTheme(false))
                    .forEach(theme => {
                        const [$icon, $text] = document.getElementById(`theme-options-${theme}`).getElementsByTagName("div");
                        $icon.classList.replace("text-accent", "text-neutral-600");
                        $text.classList.replace("text-accent", "text-neutral-300");
                    });
            }

            function getTheme(system_theme = true) {
                const system = system_theme ? getSystemTheme() : "system";
                return localStorage.theme ?? system;
            }

            function getSystemTheme() {
                return window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "system-dark" 
                    : "system-light";
            }
        </script>
    </body>
</html>
